{% extends "base.html" %}
{% load static %}

{% block title %}Traffic Control Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
  <h2 class="text-center mb-4">ðŸš¦ Smart Traffic Control Dashboard</h2>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#predictedQueue">Predicted Queue</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#mlPerformance">ML Model Performance</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#signalState">Signal State</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#flowStats">Flow Stats</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#historicalLogs">Historical Logs</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#syncOverview">Synchronization Overview</button></li>

  </ul>

  <div class="tab-content mt-4">

    <!-- Tab 1: Predicted Queue -->
    <div class="tab-pane fade show active" id="predictedQueue">
      <h5>Predicted Queue per Intersection (EMA + ML)</h5>
      <canvas id="queueChart" height="120"></canvas>
    </div>

    <!-- Tab 2: ML Model Performance -->
    <div class="tab-pane fade" id="mlPerformance">
      <h5>ML Training Metrics (MAE & RÂ²)</h5>
      <canvas id="metricsChart" height="120"></canvas>
    </div>

    <!-- Tab 3: Signal State -->
    <div class="tab-pane fade" id="signalState">
      <h5>Live Signal States (Green/Red with Remaining Time)</h5>
      <table class="table table-striped text-center align-middle mt-3" id="signalStateTable">
        <thead class="table-primary">
          <tr>
            <th>Intersection</th>
            <th>Direction</th>
            <th>Signal State</th>
            <th>Remaining Time (s)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Tab 4: Flow Stats -->
    <div class="tab-pane fade" id="flowStats">
      <h5>Vehicle Flow per Intersection</h5>
      <table class="table table-bordered text-center align-middle mt-3" id="flowStatsTable">
        <thead class="table-success">
          <tr>
            <th>Intersection</th>
            <th>Vehicles Passed</th>
            <th>Avg Queue Length</th>
            <th>Last Updated</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Tab 5: Historical Logs -->
    <div class="tab-pane fade" id="historicalLogs">
      <h5>Recent Signal Cycle History</h5>
      <canvas id="historicalChart" height="120"></canvas>
    </div>
  </div>
</div>

<!-- Tab 5: Synchronization Overview -->
<div class="tab-pane fade" id="syncOverview" role="tabpanel">
  <h5 class="mt-3">Synchronization Overview (Offsets relative to master)</h5>

  <div class="row mt-2">
    <div class="col-md-6">
      <div id="sync-table-container" class="table-responsive">
        <!-- table populated by JS -->
      </div>
    </div>

    <div class="col-md-6">
      <canvas id="syncOffsetChart" height="300"></canvas>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// ==========================
// Global Chart Instances
// ==========================
let queueChart, metricsChart, historicalChart;

// ==========================
// Fetch Data
// ==========================
function fetchAllData() {
  fetch("{% url 'dashboard_data_api' %}")
    .then(r => r.json())
    .then(data => updateQueueChart(data.predictions));

  fetch("{% url 'training_metrics_api' %}")
    .then(r => r.json())
    .then(data => updateMetricsChart(data));

  fetch("{% url 'signal_state' %}")
    .then(r => r.json())
    .then(data => updateSignalStateTable(data));

  fetch("{% url 'flow_stats' %}")
    .then(r => r.json())
    .then(data => updateFlowStatsTable(data));

  fetch("{% url 'historical_logs' %}")
    .then(r => r.json())
    .then(data => updateHistoricalChart(data));
}

// ==========================
// Predicted Queue Chart
// ==========================
function updateQueueChart(predictions) {
  const ctx = document.getElementById('queueChart').getContext('2d');
  if (queueChart) queueChart.destroy();

  const labels = new Set();
  const datasets = [];

  Object.entries(predictions).forEach(([intersection, lanes]) => {
    Object.keys(lanes).forEach(l => labels.add(l));
    datasets.push({
      label: intersection,
      data: Object.values(lanes),
      borderWidth: 2,
      backgroundColor: `hsl(${Math.random()*360}, 70%, 60%)`
    });
  });

  queueChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [...labels],
      datasets
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });
}

// ==========================
// ML Metrics Chart
// ==========================
function updateMetricsChart(data) {
  const ctx = document.getElementById('metricsChart').getContext('2d');
  if (metricsChart) metricsChart.destroy();

  metricsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.timestamps,
      datasets: [
        {
          label: 'MAE',
          data: data.mae,
          borderColor: 'red',
          borderWidth: 2,
          fill: false,
        },
        {
          label: 'RÂ²',
          data: data.r2,
          borderColor: 'green',
          borderWidth: 2,
          fill: false,
        }
      ]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { position: 'bottom' } }
    }
  });
}

// ==========================
// Signal State Table
// ==========================
function updateSignalStateTable(data) {
  const tbody = document.querySelector("#signalStateTable tbody");
  tbody.innerHTML = "";
  Object.entries(data).forEach(([intersection, dirs]) => {
    Object.entries(dirs).forEach(([dir, info]) => {
      const colorClass = info.state === 'green' ? 'table-success' : 'table-danger';
      tbody.innerHTML += `
        <tr class="${colorClass}">
          <td>${intersection}</td>
          <td>${dir}</td>
          <td><strong>${info.state.toUpperCase()}</strong></td>
          <td>${info.remaining_time}</td>
        </tr>
      `;
    });
  });
}

// ==========================
// Flow Stats Table
// ==========================
function updateFlowStatsTable(data) {
  const tbody = document.querySelector("#flowStatsTable tbody");
  tbody.innerHTML = "";
  Object.entries(data).forEach(([intersection, stats]) => {
    tbody.innerHTML += `
      <tr>
        <td>${intersection}</td>
        <td>${stats.vehicles_passed}</td>
        <td>${stats.avg_queue_length}</td>
        <td>${new Date(stats.timestamp).toLocaleTimeString()}</td>
      </tr>
    `;
  });
}

// ==========================
// Historical Logs Chart
// ==========================
function updateHistoricalChart(data) {
  const ctx = document.getElementById('historicalChart').getContext('2d');
  if (historicalChart) historicalChart.destroy();

  const labels = data.map(e => e.timestamp);
  const greenTimes = data.map(e => e.green_time);

  historicalChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Green Time (s)',
        data: greenTimes,
        borderColor: '#007bff',
        borderWidth: 2,
        fill: false,
      }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });
}
async function loadSyncOverview() {
  try {
    const res = await fetch("{% url 'sync_status' %}");
    if (!res.ok) throw new Error('Sync API error');
    const payload = await res.json();

    // Build table HTML
    const tableContainer = document.getElementById('sync-table-container');
    let html = '';
    payload.groups.forEach(group => {
      html += `<h6 class="mt-2">${group.name} (master: ${group.master})</h6>`;
      html += `<table class="table table-sm table-bordered"><thead><tr>
        <th>Intersection</th><th>Exists</th><th>Distance (m)</th><th>Travel Time (s)</th><th>Offset (s)</th>
      </tr></thead><tbody>`;
      group.rows.forEach(r => {
        html += `<tr>
          <td>${r.intersection}</td>
          <td>${r.exists ? 'âœ“' : 'â€”'}</td>
          <td>${r.distance_m}</td>
          <td>${r.travel_time_s !== null ? r.travel_time_s : 'â€”'}</td>
          <td>${r.offset_s !== null ? r.offset_s : 'â€”'}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
    });
    tableContainer.innerHTML = html;

    // Build single chart showing offsets grouped (flatten rows)
    // labels = "Group: Intersection", data = offset_s (can be negative)
    const labels = [];
    const data = [];
    const bg = [];
    payload.groups.forEach((group, gi) => {
      group.rows.forEach(r => {
        labels.push(`${group.name}: ${r.intersection}`);
        data.push(r.offset_s || 0);
        // color by group
        const hue = (gi * 80) % 360;
        bg.push(`hsl(${hue} 70% 60% / 0.85)`);
      });
    });

    // create or update Chart.js horizontal bar (indexAxis: 'y')
    const ctx = document.getElementById('syncOffsetChart').getContext('2d');
    if (window.syncOffsetChart) {
      window.syncOffsetChart.data.labels = labels;
      window.syncOffsetChart.data.datasets[0].data = data;
      window.syncOffsetChart.data.datasets[0].backgroundColor = bg;
      window.syncOffsetChart.update();
    } else {
      window.syncOffsetChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Offset (s)',
            data,
            backgroundColor: bg,
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          scales: {
            x: {
              title: { display: true, text: 'Offset (seconds) relative to master' },
              ticks: { beginAtZero: true }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => ` ${ctx.parsed.x} s`
              }
            }
          }
        }
      });
    }
  } catch (err) {
    console.error("Failed to load sync overview:", err);
  }
}

// initial load + periodic refresh (30s)
document.addEventListener('DOMContentLoaded', () => {
  loadSyncOverview();
  setInterval(loadSyncOverview, 30000);
});
// ==========================
// Auto Refresh
// ==========================
fetchAllData();
setInterval(fetchAllData, 10000);
</script>
{% endblock %}
